version: 2

sources:
  - name: public
    description: "Raw data loaded from the stock market ELT pipeline."
    tables:
      - name: source_polygon_stock_bars_daily
        description: "Raw daily OHLCV data for all tickers from Polygon.io."
        freshness:
          warn_after: {count: 1, period: day}
        loaded_at_field: "inserted_at"
      - name: source_polygon_options_bars_daily
        description: "Raw daily OHLCV data for all options contracts from Polygon.io."
        freshness:
          warn_after: {count: 1, period: day}
        loaded_at_field: "inserted_at"

models:
  - name: stg_polygon__stock_bars_casted
    description: "Cleans and renames data from the stock_bars snapshot, selecting only the currently valid records. This model serves as the foundation for all downstream transformations."
    columns:
      - name: stock_bar_id
        description: "The unique identifier for a single day's stock bar."
        tests:
          - unique
          - not_null
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: '^[A-Z0-9\.]+_[0-9]{4}-[0-9]{2}-[0-9]{2}$'
      - name: trade_date
        description: "The date of the stock bar."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              arguments:
                column_type: date
      - name: open_price
        description: "The opening price for the day."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 0
                row_condition: "ticker not like '%%CASH%%'"
      - name: high_price
        description: "The highest price for the day."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 0
      - name: low_price
        description: "The lowest price for the day."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 0
      - name: close_price
        description: "The closing price for the day."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 0
      - name: volume
        description: "The trading volume for the day."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 0
    tests:
      - dbt_expectations.expect_column_pair_values_A_to_be_greater_than_B:
          arguments:
            column_A: high_price
            column_B: low_price
            or_equal: true
  - name: stg_polygon__options_bars_casted
    description: "Cleans and renames data from the options snapshot, selecting only currently valid records."
    columns:
      - name: option_bar_id
        description: "The unique identifier for a single day's option bar (symbol + trade_date)."
        tests:
          - unique
          - not_null
      - name: option_symbol
        description: "The unique symbol for the option contract."
      - name: underlying_ticker
        description: "The ticker symbol of the underlying stock."
      - name: trade_date
        description: "The date of the option bar."
      - name: expiration_date
        description: "The expiration date of the option contract."
      - name: strike_price
        description: "The strike price of the option contract."
      - name: option_type
        description: "The type of option (call or put)."
      - name: open_price
        description: "The opening price for the day."
      - name: high_price
        description: "The highest price for the day."
      - name: low_price
        description: "The lowest price for the day."
      - name: close_price
        description: "The closing price for the day."
      - name: volume
        description: "The trading volume for the day."
      - name: volume_weighted_average_price
        description: "The volume-weighted average price for the day."
      - name: transactions
        description: "The number of transactions for the day."
      - name: loaded_at
        description: "The timestamp when the record was loaded into the raw source table."
